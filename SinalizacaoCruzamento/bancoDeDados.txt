-- DROP DATABASE CameraCruzamento;

CREATE DATABASE IF NOT EXISTS CameraCruzamento
    DEFAULT CHARACTER SET utf8mb4
    DEFAULT COLLATE utf8mb4_general_ci;

USE CameraCruzamento;

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
START TRANSACTION;
SET time_zone = "+00:00";

SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT;
SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS;
SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION;
SET NAMES utf8mb4;

-- Usuários do sistema (Secretaria, Operador, etc.)
CREATE TABLE Usuarios (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    email VARCHAR(100) NOT NULL UNIQUE,
    senha VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Dispositivos (Câmeras)
CREATE TABLE Dispositivos (
    id INT AUTO_INCREMENT PRIMARY KEY,
    nome VARCHAR(100) NOT NULL,
    id_ponto VARCHAR(50) NOT NULL,
    localizacao VARCHAR(255) NOT NULL, -- endereço ou coordenadas
    status ENUM('Ativo', 'Inativo', 'Manutenção') NOT NULL DEFAULT 'Ativo',
    observacao VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE (id_ponto) -- Adicionando restrição de unicidade para id_ponto
) DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

-- Eventos detectados pelas câmeras
CREATE TABLE Eventos_Cameras (
    id INT AUTO_INCREMENT PRIMARY KEY,
    id_camera INT NOT NULL,
    id_ponto VARCHAR(50) NOT NULL,
    timestamp DATETIME NOT NULL,
    tipo ENUM('carro', 'caminhao', 'moto', 'onibus', 'pedestre') NOT NULL,
    status_camera ENUM('Ativo', 'Inativo', 'Manutenção') NOT NULL,
    observacao VARCHAR(255),
    FOREIGN KEY (id_camera) REFERENCES Dispositivos(id)
        ON DELETE CASCADE
        ON UPDATE CASCADE
) DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_general_ci;

COMMIT;

-- Exemplo de inserção de usuário (senha: admin, gerada com password_hash)
INSERT INTO Usuarios (nome, email, senha) VALUES
('Administrador', 'admin@gmail.com', 'admin');

-- Exemplo de inserção de dispositivos
INSERT INTO Dispositivos (nome, id_ponto, localizacao, status, observacao) VALUES
('Câmera Cruzamento 1', 'P1', '-23.55052,-46.633308', 'Ativo', 'Cruzamento Av. Paulista x Rua Augusta'),
('Câmera Cruzamento 2', 'P2', '-23.551234,-46.634567', 'Manutenção', 'Cruzamento Av. Brasil x Rua Bela Vista');

-- Exemplo de inserção de eventos
INSERT INTO Eventos_Cameras (id_camera, id_ponto, timestamp, tipo, status_camera, observacao) VALUES
(1, 'P1', '2025-10-01 14:23:00', 'carro', 'em funcionamento', 'Trânsito normal'),
(2, 'P2', '2025-10-01 14:25:00', 'pedestre', 'pouco alterado', 'Movimento incomum detectado');

-- Índices para melhorar performance em buscas
CREATE INDEX idx_eventos_id_ponto ON Eventos_Cameras(id_ponto);
CREATE INDEX idx_eventos_timestamp ON Eventos_Cameras(timestamp);
